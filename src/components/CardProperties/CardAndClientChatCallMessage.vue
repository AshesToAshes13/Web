<template>
  <span
    v-if="message.type === 'call'"
    class="flex p-[10px] rounded-t-[12px] mb-[5px] max-w-[300px] text-[#4C4C4D] text-[14px]"
    :class="{'float-left rounded-br-[12px] bg-[#FCEBEB]': message.direction === 'in', 'float-right rounded-bl-[12px] bg-[#F4F5F7]': message.direction === 'out'}"
  >
    <div
      class="flex flex-col content-start gap-[5px]"
    >
      <div class="flex flex-row align-left items-center px-2">
        <svg
          class="mr-[5px]"
          width="16"
          height="17"
          viewBox="0 0 16 17"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M8.10171 7.24457L12.4121 2.92857H9.35714V2H14V6.64286H13.0714V3.58786L8.75543 7.89921L8.10171 7.2455V7.24457ZM11.1706 9.6245C11.5538 9.62451 11.9215 9.77566 12.1939 10.0451C12.2961 10.1473 12.4094 10.2531 12.5347 10.3646L12.934 10.7202C13.0733 10.8456 13.2042 10.9765 13.3249 11.1111C13.4456 11.2467 13.5599 11.3851 13.6666 11.5253C13.7725 11.6646 13.8524 11.815 13.9053 11.9747C13.9591 12.1344 13.9907 12.2941 14 12.4539C13.9996 12.8367 13.8485 13.204 13.5794 13.4762C13.3324 13.7232 13.1104 13.9405 12.9117 14.1299C12.7235 14.3105 12.5169 14.4708 12.2951 14.6081C12.0816 14.7381 11.8429 14.8356 11.5774 14.8988C11.2699 14.9662 10.9561 15.0001 10.6414 15C10.0906 14.9964 9.5433 14.9132 9.01636 14.753C8.44122 14.5811 7.88447 14.3528 7.35421 14.0714C6.78748 13.7712 6.24674 13.4242 5.73757 13.0342C5.20922 12.632 4.70967 12.1932 4.24257 11.7212C3.77364 11.2476 3.33814 10.7462 2.937 10.2197C2.54907 9.71391 2.20664 9.17479 1.91371 8.60864C1.64128 8.08155 1.41809 7.53042 1.247 6.96229C1.08763 6.44502 1.00443 5.90731 1 5.36607C1 4.99836 1.03157 4.6845 1.09471 4.42264C1.15326 4.17207 1.25104 3.93233 1.38443 3.71229C1.51443 3.49871 1.67507 3.29443 1.86357 3.09571C2.05207 2.897 2.27214 2.67229 2.52286 2.42064C2.79549 2.15094 3.16357 1.99977 3.54707 2C3.7885 2 4.02064 2.065 4.2435 2.195C4.46636 2.32686 4.68179 2.48564 4.88979 2.67507C5.09686 2.86357 5.28907 3.06136 5.46271 3.26936C5.63636 3.47736 5.80071 3.65657 5.95486 3.80607C6.22434 4.07848 6.37549 4.44618 6.3755 4.82936C6.37882 5.00317 6.34725 5.17589 6.28264 5.33729C6.22386 5.48036 6.14575 5.6147 6.0505 5.73657C5.95761 5.85326 5.85544 5.96226 5.745 6.0625C5.63357 6.16464 5.53236 6.26121 5.44043 6.35314C5.3551 6.43756 5.27509 6.52718 5.20086 6.6215C5.13506 6.70327 5.10168 6.8064 5.10707 6.91121C5.10707 6.96971 5.15071 7.06164 5.23707 7.187C5.34919 7.34379 5.47042 7.49386 5.60014 7.63643C5.96077 8.04163 6.33585 8.43374 6.72464 8.812C6.94193 9.02557 7.15271 9.22986 7.35607 9.42857C7.5585 9.62729 7.75536 9.81578 7.94386 9.995C8.13236 10.1733 8.29207 10.3256 8.42207 10.4519C8.55207 10.5772 8.65421 10.6747 8.72664 10.7416C8.80936 10.8274 8.9202 10.8805 9.03889 10.8912C9.15757 10.902 9.27615 10.8696 9.37293 10.8001C9.45929 10.7369 9.54936 10.6589 9.64129 10.5679C9.73321 10.4751 9.827 10.3739 9.92357 10.2624C10.0201 10.151 10.1316 10.0498 10.2579 9.95786C10.3832 9.86593 10.516 9.78607 10.6571 9.71829C10.8189 9.647 10.9951 9.61487 11.1716 9.6245H11.1706ZM10.6414 14.0714C10.9366 14.0714 11.1827 14.0445 11.3814 13.9916C11.5754 13.9403 11.7593 13.8568 11.9256 13.7446C12.0899 13.6331 12.2441 13.5031 12.3899 13.3536C12.5347 13.2032 12.7111 13.0268 12.9191 12.8244C13.0213 12.7222 13.0714 12.6015 13.0714 12.4613C13.0714 12.3981 13.0324 12.309 12.9554 12.192C12.8641 12.0576 12.7671 11.9272 12.6647 11.8011C12.541 11.6473 12.4076 11.5015 12.2654 11.3646C12.1169 11.2207 11.9711 11.087 11.8309 10.9663C11.7088 10.8596 11.5805 10.7603 11.4464 10.6691C11.3304 10.5921 11.2384 10.5531 11.1706 10.5531C11.0667 10.5538 10.9656 10.5866 10.8809 10.6469C10.7832 10.7144 10.6929 10.7923 10.6116 10.879C10.5253 10.9719 10.4306 11.0731 10.3294 11.1845C10.2272 11.2959 10.1158 11.3971 9.99507 11.4891C9.87436 11.581 9.74157 11.6609 9.59579 11.7286C9.43636 11.7988 9.26278 11.831 9.08879 11.8224C8.89827 11.8236 8.70947 11.7864 8.53366 11.713C8.35784 11.6396 8.19862 11.5316 8.0655 11.3953L4.60564 7.93357C4.47204 7.8009 4.366 7.64311 4.29364 7.46929C4.22038 7.29184 4.18101 7.10223 4.17757 6.91029C4.17757 6.72179 4.20914 6.55464 4.27136 6.40979C4.3345 6.26493 4.41157 6.12936 4.5035 6.00307C4.59636 5.87771 4.69757 5.76907 4.809 5.67714C4.92043 5.58521 5.02164 5.48864 5.11357 5.3865C5.2055 5.28529 5.28536 5.19614 5.35314 5.11814C5.42154 5.0378 5.45527 4.93361 5.44693 4.82843C5.44693 4.76529 5.40793 4.67614 5.33086 4.55914C5.24086 4.42647 5.14416 4.29848 5.04114 4.17564C4.91493 4.02432 4.78168 3.87899 4.64186 3.74014C4.50301 3.60031 4.35769 3.46707 4.20636 3.34086C4.08043 3.23576 3.94967 3.13661 3.8145 3.04371C3.69379 2.96107 3.60464 2.923 3.54614 2.92764C3.47741 2.92644 3.40915 2.93933 3.34559 2.96552C3.28203 2.99171 3.22451 3.03065 3.17657 3.07993C3.00121 3.25527 2.82478 3.42954 2.64729 3.60271C2.50052 3.74309 2.36915 3.89873 2.25543 4.067C2.14536 4.23352 2.06436 4.41752 2.01586 4.61114C1.95803 4.85107 1.92873 5.09699 1.92857 5.34379C1.92857 5.80807 2.00286 6.28629 2.15329 6.77936C2.31303 7.29649 2.52199 7.79711 2.77729 8.27436C3.04379 8.77671 3.36229 9.26607 3.73464 9.73964C4.107 10.2132 4.50629 10.6654 4.9325 11.0954C5.76703 11.9398 6.71979 12.6586 7.76093 13.2292C8.22937 13.4847 8.72287 13.6914 9.23364 13.8458C9.69014 13.9858 10.1639 14.0615 10.6414 14.0705V14.0714Z"
            fill="#747476"
          />
        </svg>

        <p
          class="text-[14px] leading-[21px] text-[#747476]"
        >
          {{ getCallText(message) }}
        </p>
      </div>
      <CardAndClientCallPlayer
        :call-link="message.link"
      />
    </div>
    <p
      style="color: rgba(0, 0, 0, 0.5);"
      class="text-right font-[700] ml-[8px] leading-[14px] text-[11px] self-end min-w-[30px]"
    >
      {{ getMessageTimeString(message.date_create) }}
    </p>
  </span>
  <div
    v-if="message.type === 'yandex'"
    class="text-[#7E7E80] text-[13px] font-[500] leading-[15px] tracking-wide mb-[6px]"
    :class="{ 'text-left': !isMessageIncludesIntegrationLogin(message), 'text-right': isMessageIncludesIntegrationLogin(message) }"
  >
    <span class="w-[300px] overflow-hidden h-[15px] inline-block text-ellipsis whitespace-nowrap">{{ message.email_creator }}</span>
  </div>
</template>

<script>
import CardAndClientCallPlayer from './CardAndClientCallPlayer.vue'

export default {
  components: {
    CardAndClientCallPlayer
  },
  props: {
    message: {
      type: Object,
      default: () => {}
    }
  },
  methods: {
    getCallText (message) {
      const minutes = Math.floor(message.duration / 60)
      const seconds = (message.duration % 60).toString().padStart(2, '0')
      return (message.direction === 'in' ? 'Звонок от контакта' : `Звонок от ${message.user}`) + ` (${minutes}:${seconds})`
    },
    getMessageTimeString (dateCreate) {
      if (!dateCreate) return ''
      // добавляем Z в конец, чтобы он посчитал что это UTC время
      if (dateCreate[dateCreate.length - 1] !== 'Z') {
        dateCreate += 'Z'
      }
      const date = new Date(dateCreate)
      return date.toLocaleString('default', {
        hour: 'numeric',
        minute: 'numeric'
      })
    },
    isMessageIncludesIntegrationLogin (msg) {
      if (msg.type === 'yandex') {
        return msg.email_creator.includes(this.corpYandexIntegration?.login) || msg.email_creator.includes(this.personalYandexIntegration?.login)
      }
      return false
    }
  }
}
</script>
